{{- $replicas := int .Values.replicaCount }}
{{- $fullname := .Values.mlbackend.mlreleasename }}
{{- $service := .Values.mlbackend.mlreleasename }}
{{- $namespace := .Values.mlbackend.mlnamespace }}
## HAProxy daemon configuration
# ref: https://www.haproxy.org/download/2.2/doc/configuration.txt
global
    log stdout format raw local0
    maxconn 1024

defaults
    log global
    option forwardfor
    timeout client 60s
    timeout connect 60s
    timeout server 60s

resolvers dns
    nameserver k8s-dns 10.43.0.10:53


    # Maximum size of a DNS answer allowed, in bytes
    accepted_payload_size 8192

    # Whether to add nameservers found in /etc/resolv.conf
    parse-resolv-conf

    # How long to "hold" a backend server's up/down status depending on the name resolution status.
    # For example, if an NXDOMAIN response is returned, keep the backend server in its current state (up) for
    # at least another 30 seconds before marking it as down due to DNS not having a record for it.
    hold valid    10s
    hold other    30s
    hold refused  30s
    hold nx       30s
    hold timeout  30s
    hold obsolete 30s

    # How many times to retry a query
    resolve_retries 3

    # How long to wait between retries when no valid response has been received
    timeout retry 5s


    # How long to wait for a successful resolution
    timeout resolve 5s


frontend stats
    mode http
    bind *:1024
    stats enable
    http-request use-service prometheus-exporter if { path /metrics }
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

### Applicative Plane ###

## Query Console

frontend ml-test-query
    mode http
    bind :8000
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-query

backend ml-test-query
    mode http
    balance uri
    option forwardfor
    cookie SERVER insert indirect nocache
    {{- range $i := until $replicas }}
    server ml-{{ $i }} {{ $fullname }}-{{ $i }}.{{ $service }}-headless.{{ $namespace }}.svc.cluster.local:8000 check resolvers dns init-addr none cookie ml-{{ $i }}-8000
    {{- end }}
## Admin UI

frontend ml-test-admin
    mode http
    bind :8001
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-admin

backend ml-test-admin
    mode http
    balance uri
    cookie SERVER insert indirect nocache
    {{- range $i := until $replicas }}
    server ml-{{ $i }} {{ $fullname }}-{{ $i }}.{{ $service }}-headless.{{ $namespace }}.svc.cluster.local:8001 check resolvers dns init-addr none cookie ml-{{ $i }}-8001
    {{- end }}

## Hello-World ##

frontend hello-world
    mode http
    bind :8021
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend hello-world

backend hello-world
    mode http
    balance uri
    cookie SERVER insert indirect nocache
    server ml-0 {{ .Values.mlbackend.mlreleasename }}-0.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8021 check resolvers dns init-addr none cookie ml-0-8021
    server ml-1 {{ .Values.mlbackend.mlreleasename }}-1.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8021 check resolvers dns init-addr none cookie ml-1-8021
    server ml-2 {{ .Values.mlbackend.mlreleasename }}-2.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8021 check resolvers dns init-addr none cookie ml-2-8021  

## Manage 

frontend ml-test-manage
    mode http
    bind :8002
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-manage

backend ml-test-manage
    mode http
    balance uri
    cookie SERVER insert indirect nocache
    server ml-0 {{ .Values.mlbackend.mlreleasename }}-0.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8002 check resolvers dns init-addr none cookie ml-0-8002
    server ml-1 {{ .Values.mlbackend.mlreleasename }}-1.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8002 check resolvers dns init-addr none cookie ml-1-8002
    server ml-2 {{ .Values.mlbackend.mlreleasename }}-2.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8002 check resolvers dns init-addr none cookie ml-2-8002


### Admin Plane ###

## Query console

frontend ml-test-console-0
    mode http
    bind :80
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-console-0

frontend ml-test-console-1
    mode http
    bind :81
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-console-1

frontend ml-test-console-2
    mode http
    bind :82
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-console-2

backend ml-test-console-0
    mode http
    server ml-0 {{ .Values.mlbackend.mlreleasename }}-0.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8000 check resolvers dns init-addr none check

backend ml-test-console-1
    mode http
    server ml-1 {{ .Values.mlbackend.mlreleasename }}-1.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8000 check resolvers dns init-addr none check

backend ml-test-console-2
    mode http
    server ml-2 {{ .Values.mlbackend.mlreleasename }}-2.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8000 check resolvers dns init-addr none check


## Admin UI

frontend ml-test-admin-0
    mode http
    bind :83
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-admin-0

frontend ml-test-admin-1
    mode http
    bind :84
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-admin-1

frontend ml-test-admin-2
    mode http
    bind :85
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-admin-2

backend ml-test-admin-0
    mode http
    server ml-0 {{ .Values.mlbackend.mlreleasename }}-0.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8001 check resolvers dns init-addr none check

backend ml-test-admin-1
    mode http
    server ml-1 {{ .Values.mlbackend.mlreleasename }}-1.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8001 check resolvers dns init-addr none check

backend ml-test-admin-2
    mode http
    server ml-2 {{ .Values.mlbackend.mlreleasename }}-2.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8001 check resolvers dns init-addr none check


## Manage

frontend ml-test-manage-0
    mode http
    bind :86
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-manage-0

frontend ml-test-manage-1
    mode http
    bind :87
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-manage-1

frontend ml-test-manage-2
    mode http
    bind :88
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    default_backend ml-test-manage-2

backend ml-test-manage-0
    mode http
    server ml-0 {{ .Values.mlbackend.mlreleasename }}-0.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8002 check resolvers dns init-addr none check

backend ml-test-manage-1
    mode http
    server ml-1 {{ .Values.mlbackend.mlreleasename }}-1.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8002 check resolvers dns init-addr none check

backend ml-test-manage-2
    mode http
    server ml-2 {{ .Values.mlbackend.mlreleasename }}-2.{{ .Values.mlbackend.mlreleasename }}-headless.{{ .Values.mlbackend.mlnamespace }}.svc.cluster.local:8002 check resolvers dns init-addr none check
